<!DOCTYPE html>

<!-- 
TODO
[x] document json with metadata, title and UID key name
[x] app metadata, last open file
[x] start off with initial document

[ ] mini Vdom

[ ] draw sidebar
    [ ] click file to open
    [ ] new file button

[ ] insert context menu
[ ] slash, todo, and bullet list inference at start of top level element
[ ] key commands

 -->

<head>

  <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='.8 .8 14.4 14.4'><path d='M10 8.99a1 1 0 00-.695 1.717l4.004 4a1 1 0 101.414-1.414l-4.004-4A1 1 0 0010 8.99z' fill='%2380b0ff' stroke='%235D7FDDaa' stroke-width='.3'/><path d='M6.508 1C3.48 1 1.002 3.474 1.002 6.5S3.48 12 6.508 12s5.504-2.474 5.504-5.5S9.536 1 6.508 1zm0 2a3.486 3.486 0 013.504 3.5c0 1.944-1.556 3.5-3.504 3.5a3.488 3.488 0 01-3.506-3.5C3.002 4.556 4.56 3 6.508 3z' fill='%2380b0ff' stroke='%235D7FDDaa' stroke-width='.3'/></svg>">
  
  <style>
    body {
      background-color: silver;
      margin: 0;
      font-family: 'Courier New', Courier, monospace;
    }

    sidebar {
      position: absolute;
      top: 0px;
      bottom: 0px;
      width: 200px;
      border-right: 1px solid black;
      padding: 1em;
    }

    sidebar p {
        font-size: 0.8em;
      }

    note {
      position: absolute;
      background: white;
      left: 200px;
      top: 0px;
      bottom: 0px;
      right: 0px;
      padding: 1em;
    }
  </style>
</head>

<body>
  <sidebar>
    <h2>localnotes</h2>
    <content>

    </content>
  </sidebar>
  <note contenteditable="true"></note>

  <script>
    const DOC_VERSION = 0;
    var note = null;

    function el(tag, attrs, text) {
      e = document.createElement(tag)
      for ([k, v] of Object.entries(attrs || {})) {
        e.setAttribute(k, v)
      }
      if (text) {
        e.appendChild(document.createTextNode(text))
      }
      return e
    }

    function SaveMeta(){
      localStorage.setItem('meta', JSON.stringify(meta))
    }

    function NewDocument() {
      return {
        uid: Math.random().toString(16).slice(2),
        title: "Untitled Document",
        content: "",
        version: DOC_VERSION}
    }

    function OpenDocument(uid) {
      note = JSON.parse(localStorage.getItem(uid)) || NewDocument()
      meta.current_note = note.uid
    }

    function SaveNote() {
      s = document.querySelector("note").innerHTML
      note.content = s
      localStorage.setItem(note.uid, JSON.stringify(note))
    }

    function MountNote() {
      document.querySelector("note").innerHTML = note.content
    }

    
    function RenderSidebar() {
      content = document.querySelector('sidebar content')
      content.innerHTML = null
      content.appendChild(el('button', {onclick: 'alert("ok!")'}, "+ new note"))
      for ([k,v] of Object.entries(localStorage)){
        if (k != 'meta') {
          try {
            o = JSON.parse(v)
            content.appendChild(el('p', {onclick: 'alert("ok!")'}, `${o.title} (${k})`))
          } catch (error) {
            console.error(error)
          }
          
        }
      }
    }

    document.querySelector("note").addEventListener("input", function () {
      SaveNote()
    }, false)



    var meta = JSON.parse(localStorage.getItem('meta')) || {current_note: null}

    OpenDocument(meta.current_note)

    SaveMeta()
    MountNote()
    SaveNote()
    RenderSidebar()

  </script>
</body>

</html>